<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åä½œåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .controls {
            margin: 15px 0;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Lexical åä½œåŠŸèƒ½æµ‹è¯•</h1>
    
    <div id="status" class="status disconnected">
        âŒ æœªè¿æ¥
    </div>
    
    <div class="controls">
        <input type="text" id="username" placeholder="ç”¨æˆ·å" value="">
        <input type="text" id="roomId" placeholder="æˆ¿é—´ID" value="test-room">
        <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
        <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div>
        <h3>åœ¨çº¿ç”¨æˆ·ï¼š<span id="userList">æ— </span></h3>
    </div>
    
    <div class="controls">
        <input type="text" id="messageText" placeholder="å‘é€æµ‹è¯•æ¶ˆæ¯" style="width: 300px;">
        <button onclick="sendTestMessage()">å‘é€æ“ä½œ</button>
    </div>
    
    <div>
        <h3>è¿æ¥æ—¥å¿—ï¼š</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let ws = null;
        let userId = null;
        let currentRoom = null;
        
        // ç”Ÿæˆéšæœºç”¨æˆ·å
        document.getElementById('username').value = 'User-' + Math.random().toString(36).substr(2, 6);
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(connected, message = '') {
            const statusElement = document.getElementById('status');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.innerHTML = 'ğŸŸ¢ å·²è¿æ¥' + (message ? ` - ${message}` : '');
            } else {
                statusElement.className = 'status disconnected';
                statusElement.innerHTML = 'âŒ æœªè¿æ¥' + (message ? ` - ${message}` : '');
            }
        }
        
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return;
            }
            
            const serverUrl = 'wss://collab-server-production-2ff6.up.railway.app';
            log(`è¿æ¥åˆ°: ${serverUrl}`);
            
            ws = new WebSocket(serverUrl);
            
            ws.onopen = () => {
                log('WebSocket è¿æ¥å·²å»ºç«‹');
                updateStatus(true);
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`æ”¶åˆ°æ¶ˆæ¯: ${message.type}`);
                handleMessage(message);
            };
            
            ws.onclose = (event) => {
                log(`è¿æ¥å·²å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`);
                updateStatus(false, 'è¿æ¥å·²æ–­å¼€');
                
                // 3ç§’åé‡è¿
                if (currentRoom) {
                    setTimeout(() => {
                        log('å°è¯•é‡è¿...');
                        connectWebSocket();
                    }, 3000);
                }
            };
            
            ws.onerror = (error) => {
                log(`WebSocket é”™è¯¯: ${error}`);
                updateStatus(false, 'è¿æ¥é”™è¯¯');
            };
        }
        
        function handleMessage(message) {
            switch (message.type) {
                case 'join_room':
                    if (message.data.success) {
                        userId = message.data.userId;
                        currentRoom = message.data.roomId;
                        log(`æˆåŠŸåŠ å…¥æˆ¿é—´: ${currentRoom}, ç”¨æˆ·ID: ${userId}`);
                        updateStatus(true, `æˆ¿é—´: ${currentRoom}`);
                    }
                    break;
                    
                case 'user_list':
                    const usernames = message.data.map(user => user.username).join(', ');
                    document.getElementById('userList').textContent = usernames || 'æ— ';
                    log(`åœ¨çº¿ç”¨æˆ·: ${usernames}`);
                    break;
                    
                case 'operation':
                    log(`æ”¶åˆ°æ“ä½œ: ${JSON.stringify(message.data)}`);
                    break;
                    
                case 'editor_state':
                    log(`ç¼–è¾‘å™¨çŠ¶æ€æ›´æ–°`);
                    break;
                    
                case 'error':
                    log(`æœåŠ¡å™¨é”™è¯¯: ${message.data.message}`);
                    break;
            }
        }
        
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                log(`å‘é€æ¶ˆæ¯: ${message.type}`);
            } else {
                log('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
            }
        }
        
        function joinRoom() {
            const username = document.getElementById('username').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!username || !roomId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œæˆ¿é—´ID');
                return;
            }
            
            connectWebSocket();
            
            // ç­‰å¾…è¿æ¥å»ºç«‹åå‘é€åŠ å…¥æˆ¿é—´æ¶ˆæ¯
            const checkAndJoin = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendMessage({
                        type: 'join_room',
                        data: { roomId, username }
                    });
                } else if (ws && ws.readyState === WebSocket.CONNECTING) {
                    setTimeout(checkAndJoin, 100);
                } else {
                    log('è¿æ¥å¤±è´¥ï¼Œæ— æ³•åŠ å…¥æˆ¿é—´');
                }
            };
            
            setTimeout(checkAndJoin, 100);
        }
        
        function leaveRoom() {
            if (currentRoom) {
                sendMessage({
                    type: 'leave_room',
                    data: { roomId: currentRoom }
                });
                currentRoom = null;
                userId = null;
                updateStatus(false, 'å·²ç¦»å¼€æˆ¿é—´');
                document.getElementById('userList').textContent = 'æ— ';
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function sendTestMessage() {
            const text = document.getElementById('messageText').value;
            if (!text) {
                alert('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯');
                return;
            }
            
            sendMessage({
                type: 'operation',
                data: {
                    type: 'insert',
                    data: { text: text, position: 0 }
                }
            });
            
            document.getElementById('messageText').value = '';
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>